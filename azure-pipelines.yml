# Azure Pipeline for Full Stack App (React + Node.js)
# Self-Hosted Agent on VM

trigger:
  branches:
    include:
      - main
      - master

pool:
  name: 'VM-Pool'  # Use your self-hosted agent pool

variables:
  NODE_VERSION: '18.x'
  BACKEND_PATH: '/home/azureuser/backend-dev/server'
  FRONTEND_PATH: '/home/azureuser/frontend-dev/client'

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildBackend
        displayName: 'Build Backend'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '$(NODE_VERSION)'
          
          - script: |
              echo "Building backend..."
              cd server
              npm ci --production
            displayName: 'Install Backend Dependencies'

      - job: BuildFrontend
        displayName: 'Build Frontend'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '$(NODE_VERSION)'
          
          - script: |
              echo "Building frontend..."
              cd client
              npm ci
            displayName: 'Install Frontend Dependencies'
          
          - script: |
              cd client
              npm run build
            displayName: 'Build React App'

  - stage: Deploy
    displayName: 'Deploy to VM'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployApp
        displayName: 'Deploy Full Stack App'
        steps:
          # Deploy Backend
          - script: |
              echo "=== Deploying Backend ==="
              
              # Backup existing backend
              if [ -d "$(BACKEND_PATH)" ]; then
                echo "Creating backup..."
                cp -r $(BACKEND_PATH) $(BACKEND_PATH)_backup_$(date +%Y%m%d_%H%M%S)
              fi
              
              # Stop backend
              echo "Stopping backend..."
              pm2 stop backend-dev || true
              
              # Copy new backend files
              echo "Copying backend files..."
              cp -r $(Build.SourcesDirectory)/server/* $(BACKEND_PATH)/
              
              # Install dependencies
              cd $(BACKEND_PATH)
              npm ci --production
              
              # Restart backend
              echo "Starting backend..."
              pm2 restart backend-dev
              pm2 save
              
              echo "âœ… Backend deployed successfully!"
            displayName: 'Deploy Backend'
          
          # Deploy Frontend
          - script: |
              echo "=== Deploying Frontend ==="
              
              # Backup existing frontend
              if [ -d "$(FRONTEND_PATH)" ]; then
                echo "Creating backup..."
                cp -r $(FRONTEND_PATH) $(FRONTEND_PATH)_backup_$(date +%Y%m%d_%H%M%S)
              fi
              
              # Stop frontend
              echo "Stopping frontend..."
              pm2 stop frontend-dev || true
              
              # Copy new frontend files
              echo "Copying frontend files..."
              cp -r $(Build.SourcesDirectory)/client/* $(FRONTEND_PATH)/
              
              # Install dependencies
              cd $(FRONTEND_PATH)
              npm ci
              
              # Restart frontend
              echo "Starting frontend..."
              pm2 restart frontend-dev
              pm2 save
              
              echo "âœ… Frontend deployed successfully!"
              echo ""
              echo "ðŸš€ Application is now live at http://4.186.24.2:3000"
              pm2 status
            displayName: 'Deploy Frontend'